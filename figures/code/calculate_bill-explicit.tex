\begin{lstlisting}[float, style=dlmc, numbers=left, caption={Labelled smart meter bill calculation example}, label=example:code:calculate_bill-explicit]
principal u, ec, s;

typedef struct usage {
  int start_time;
  int usage_in_Wh;
} usage;

typedef struct price {
  int start_time;
  int price_in_cents;
} price;

usage {{u->}} *get_latest_usage();
price {{_}} *get_latest_prices();
void {{output->u}} send_to_consumer(int bill);
void {{output->ec}} send_to_electrical_company(int bill);

int {{u->u, ec}} calculate_bill() {
  int (*@\fadedlbl{s->}@*) usage_count = 100;
  int (*@\fadedlbl{s->}@*) prices_count = 100;
  usage (*@\fadedlbl{u->}@*) *latest_usage = get_latest_usage();
  price (*@\fadedlbl{s->}@*) *latest_prices = get_latest_prices();
  int (*@\fadedlbl{u->; s->}@*) result = 0;

  int (*@\fadedlbl{s->}@*) i = 0;
  int (*@\fadedlbl{u->; s->}@*) j = 0;
  while (i < usage_count) {
    while ((j < prices_count-1) &&
        (latest_prices[j+1].start_time <= latest_usage[i].start_time)) {
      j = j + 1;
    }
    result = result + latest_usage[i].usage_in_Wh *
      latest_prices[j].price_in_cents;
    i = i + 1;
  }
  this -->? u, s {
    return <|result, (*@\fadedlbl{u->u, ec}@*)|>;
  }
}

int main(int argc, char **argv) {
  int (*@\fadedlbl{u->u, ec}@*) bill = calculate_bill();
  send_to_consumer(bill);
  send_to_electrical_company(bill);
}
\end{lstlisting}

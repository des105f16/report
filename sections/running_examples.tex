% !TEX root = ../master.tex

\section{Running Examples}
Based on the previous descriptions, we have created two examples which will work as IoT use-cases, and will be the base for our following discussions and implementation.
These examples contain only constructions supported by our implementation.

\subsection{Smart meter bill calculation}
Related to the protection of smart meter data, we have created a simple example which uses data from both consumer and electrical company in order to calculate a bill.
Here we make use of 4 auxiliary functions: \dlmc{get_latest_usage}, \dlmc{get_latest_prices}, \dlmc{send_to_consumer}, and \dlmc{send_to_electrical_company}, which represent ways of either obtaining data from outside the program, or sending data to outside of the program.

\begin{lstlisting}[style=dlmc, numbers=left]
typedef struct usage {
  int start_time;
  int usage_in_Wh;
} usage;

typedef struct price {
  int start_time;
  int price_in_cents;
} price;

usage* get_latest_usage();
price* get_latest_prices();
void send_to_consumer(int bill);
void send_to_electrical_company(int bill);

int calculate_bill() {
  int usage_count = 100;
  int prices_count = 100;
  usage *latest_usage = get_latest_usage();
  price *latest_prices = get_latest_prices();
  int result = 0;

  int i = 0;
  int j = 0;
  while (i < usage_count) {
    while ((j < prices_count-1) && (latest_prices[j+1].start_time <= latest_usage[i].start_time)) {
      j = j + 1;
    }
    result = result + latest_usage[i].usage_in_Wh * latest_prices[j].price_in_cents;
    i = i + 1;
  }
  return result;
}

int main(int argc, char **argv) {
  int bill = calculate_bill();
  send_to_consumer(bill);
  send_to_electrical_company(bill);
}
\end{lstlisting}

\subsection{Password checker}
A more general example is a simple password checker, which checks a given username and password combination and checks it against the user database, giving a response to the user whether it was correct or not.
Here we have two auxiliary functions: \dlmc{get_users} -- which simply gets the total list of username/password from somewhere outside the program, and \dlmc{send_response} -- which sends the response to the requesting user to outside the program.

\begin{lstlisting}[style=dlmc, numbers=left]
#include <stdbool.h>
#include <string.h>

typedef struct user_info {
  char username[20];
  char password[20];
} user_info;

user_info* get_users();
void send_response(bool is_match);

bool check_password(char *username, char *password) {
  int user_count = 100;
  user_info *users = get_users();
  int i = 0;
  bool match = false;

  while (i < user_count) {
    if (!strcmp(users[i].username, username) && !strcmp(users[i].password, password)) {
      match = true;
    }
    i = i + 1;
  }

  return match;
}

int main(int argc, char **argv) {
  bool is_match = check_password(argv[1], argv[2]);
  send_response(is_match);
}
\end{lstlisting}
